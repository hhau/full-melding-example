---
title: "ICU + Severity Example for `wsre`"
author: "Andrew Manderson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
fontfamily: tgpagella
fontsize: 10pt
papersize: a4
geometry: margin=2.25cm
bibliography: ../0bibliography/year-1-bib.bib
csl: aam71-test.csl
output: 
  pdf_document:
    includes:
      in_header:
        tex-input/pre.tex
    fig_caption: true
    number_sections: true
    keep_tex: true
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = NA, out.width = "85%", fig.align = "center", auto_pdf = TRUE)
```

# Model origins

@presanis:etal:14 undertakes a large evidence synthesis in order to estimate the severity of the H1N1 pandemic amongst the population of England.
The H1N1 pandemic occurred in three _waves_, and the change in severity between waves is of interest.
Due to the time between waves, the available sources of data differ between waves.
During the third wave some data sources had a decrease in typical sample size, and began aggregating previously available data in a coarser manner.
To ameliorate the impact of the data coarsening, independent data on one aspect of the large severity model, the number of suspected influenza cases in hospital's intensive care units (ICU), can be incorporated.
@goudie:etal:18 presents a Markov melding approach for joining the independent ICU model with a simplified version of the larger severity model.

We consider this same pair of models here, as the melded parameter has an unknown prior marginal distribution under both models, and the independent nature of the data sources could result in a degree of conflict between the various intermediary melding distributions.
This is also an example of the Markov melding where the melded model has no obvious implied joint model, as the link parameter is not a root node in either model.

## ICU

The data for the ICU submodel considers aggregate weekly counts of patients in the ICU of all the hospitals in England.
Such data is an underestimate of the true number of patients affected by H1N1 influenza, and also requires careful temporal consideration, as patients enter and exit the ICU in a stochastic manner.
The third wave of the H1N1 influenza predominantly occurred during a 78 day block between December 2010 and February 2011.
ICU observations were recorded weekly on days $U = \{8, 15, \ldots, 78\}$, and considered the number of children $a = 1$ and adults $a = 2$ in the ICU on the day of observation.
Denote a specific weekly observation as $y_{a, t}$ for $t \in U$.
The estimated lower bound on the cumulative number of ICU admissions over the whole 78 day block $T = \{1, 2, \ldots, 78\}$, for each age group, functions as our link parameter $\phi = (\phi_{1}, \phi_2)$.
A need to appropriately model the temporal nature of the weekly ICU data motivates a time inhomogeneous Poisson process.
The process has time inhomogeneous rate parameter $\lambda_{a, t}$ for $t \in T$, with an age group specific ICU exit rate $\mu_{a}$, which is exponentially distributed.

To address the difference between the observation times $U$, and the daily support of our Poisson process $T$, the expected number of influenza patients in the ICU at time $t$ is
\input{tex-input/icu-model/0010-thinned-poisson-process.tex}
An coherent indentifiability assumption of $\eta_{a, 1} = 0$ is required, and assumes that no influenza patients were in the ICU at time $t = 0$.

Influenza strains do not exist in isolation, hence not all ICU admissions with influenza symptoms were the result of the H1N1 pandemic.
Consider $\lambda_{a, t}$ as the expected number of _suspected_ H1N1 cases.
Weekly virological positivity data is available at weeks $V = \{1, \ldots, 11\}$, and informs the proportion of influenza cases which are attributable to the H1N1 virus $\pi_{a, t}^{\text{pos}}$.
The virology data consists of the number of H1N1-positive swabs $z_{a, v}^{\text{pos}}$ and the total number of swabs tested for influenza that week $n_{a, z}^{\text{pos}}$.
This proportion relates the counts to $\pi_{a, t}^{\text{pos}}$ a truncated uniform prior on $\pi_{a, t}^{\text{pos}}$,
\input{tex-input/icu-model/0020-pipos-unif-model.tex}
with $v = 1$ for $t = 1, 2, \ldots, 14$, and $v = \lfloor(t - 1) \mathop{/} 7 \rfloor$ to align the temporal indices.
The estimate of $\pi_{a, t}^{\text{pos}}$ is then used to compute $\phi_{a}$
\input{tex-input/icu-model/0021-phi-icu-calc.tex}
This summation is a non-invertible function, which guides our choice of model ordering when melding, which we will discuss in Section&nbsp;\ref{model-ordering}.

The priors for the remaining parameters are a lognormal random walk for the expected number of new admissions 
\input{tex-input/icu-model/0030-prior-set-one.tex}
for $t = 2, 3, \ldots, 78$, and priors for the age group specific exit rates
\input{tex-input/icu-model/0040-prior-set-two.tex}

## Severity

A simplified version of the remaining components of the large severity model of @presanis:etal:14 is considered here.
The estimate of the cumulative number of ICU admissions $\phi_{a}$ is assumed to be an underestimate of the true number of of ICU admissions due to H1N1 $\chi_{a}$.
The model we consider to address this is 
\input{tex-input/icu-model/0050-sev-submodel.tex}
where $\pi^{\text{det}}$ is the age group constant probability of detection, and the priors on $\chi_{a}$ are appropriate summaries of the other components of the larger severity model.

## Model ordering

Here, there is a natural ordering due to the non-invertible link function used to compute $\phi_{a}$.

The multi-stage Metropolis-Hastings MCMC approach of @goudie:etal:18 requires us to choose an order, i.e. which submodel should be in which stage.
In general melding is mathematically insensitive to this ordering, as any deterministic, non-invertible link function can be extended into an invertible one without theoretically affecting the output of the sampling process.
However, in practice the performance of the multi-stage sampler heavily depends on the choice of link function extension, and hence the order of the submodels is important.

<!-- I'm not sure the following is okay in general, need some comment about how this lines up with our specific example. -->
A natural ordering is to consider the "widest" submodel first.
This way we are least sensitive to differences in location between the models.
The cost is that we are susceptible to particle degeneracy, as there may be few samples from the wider submodel in the region of support under the melded model.
Recognising particle degeneracy is a relatively well understood problem [cite SMC ESS paper or something], which is an easier to address problem than having a particle system that is too narrow to begin with.

# Compare the Priors

See Figure&nbsp;\ref{fig:prior_comparison}.

- In both the severity model and the ICU model, the prior marginal distribution for $\phi$ is unknown.
- However, the prior distribution for $\phi$ in the ICU models is practically flat in the ROI (See left panel of figure 1)
- This implies that the self-density ratio of two points in the ROI is effectively 1 everywhere.
- Using the naive KDE gives back a self-density ratio that is indistinguishable from 1 for all values of phi sampled in stage one. (SHOW THIS?)

```{r prior_comparison, fig.cap = "Prior comparison, should look like the original melding paper."}
knitr::include_graphics("plots/prior-comparison.pdf")
```

- The severity model has a prior marginal distribution for $\phi$ that is not flat everywhere.
- This is a good property from an evidence synthesis stand point (model contains useful information), however it necessitates the use of our weighted-sample self-density ratio estimation methodology.

# Sample the ICU Posterior

See Figure&nbsp;\ref{fig:icu_post_plot}.

```{r icu_post_plot, fig.cap = "ICU model posterior, same scales as prior."}
knitr::include_graphics("plots/icu-posterior.pdf")
```

- emphasise this is the stage one target, spell out the stage two target and how they cancel?
  - Don't have to do this in all the detail, refer back to methodology section.


# Estimate the severity self-density ratio using `wsre`

We use a grid of 100 points for the mean of the Gaussian weighting functions $\mu_{\wfindex}$ based on taking 10 equally spaced values, between 30 and 275 for $\phi_{1}$, and 500 and 3000 for $\phi_{2}$, and $\sigma^2_{\wfindex} = (25^2, 250^2)$ for all $\wfindex$.
Each weighted target has 1250 MCMC samples drawn from it.

For comparison, we draw 15000 samples from $\pd_{2}(\phi)$ which we use to estimate $\hat{\pd}_{2}(\phi)$

- New example uses 100 weighting functions, with 1000 samples per weighted target. Compares the output from this with naive KDE using 100000 samples.
  - Tue Sep 24 14:48:39 2019: Still waiting to see if we get the same behaviour


# Melding


## Pooled priors

<!-- - Eventually I would like to compare linear / log pooling.
    - It's an easy, drop in replacement.
 -->
- We use log pooling with equal weights, with $\lambda_{1} = \lambda_{2} = 1 \mathop{/}2$
- Log pooling results in a more dilute prior distribution that linear pooling, and this also allows us to emphasise the impact that `wsre` has on the melded posterior.


## Compare the melded output with/without wsre

### Traceplots of $\phi_{a}$ __with__ `wsre`

```{r phi_trace_wsre, fig.cap = "$\\phi$ trace with the self-density ratio estimate."}
knitr::include_graphics("plots/stage-two-wsre-phi-trace.pdf")
```

$\psi_{2}$ trace:

```{r psi_trace_wsre, fig.cap = "$\\psi_{2}$ trace, thinned to 1000 samples per chain. Mixing is governed by the mixing of $\\phi$."}
knitr::include_graphics("plots/stage-two-wsre-psi-trace.png")
```

### Traceplots of $\phi_{2}$ __without__ `wsre`

```{r phi_trace_no_wsre, fig.cap = "$\\phi$ trace without the self-density ratio estimate. We see the behaviour we saw in the toy example. Demonstrates the fragility of the example."}
knitr::include_graphics("plots/stage-two-no-wsre-phi-trace.png")
```

Explain that: 

- KDE has produced an underestimate (by many orders of magnitude) in the tails
- This leads to an acceptance probability much larger than it should be (because the proposal term is on the bottom of the MH ratio).
- Hence moves to improbable values of $\phi$ are associated with acceptance probabilities that have enormous quantities of error on them.
- Leads to chains being far too likely to move to these improbable values.
- Once at this improbable value, the KDE error then has the opposite effect, as the underestimate now results in the chain being unable to move back to probable values.
- Leads to the "staircase to nowhere" behaviour seen in Figure&nbsp;\ref{fig:phi_trace_no_wsre}.

$\psi_{2}$ trace:

```{r psi_trace_no_wsre, fig.cap = "$\\psi_{2}$ trace, thinned to 1000 samples per chain, no self-density estimate."}
knitr::include_graphics("plots/stage-two-no-wsre-psi-trace.png")
```

### Creating a similar version of Figure 8 from the original paper

```{r melded_posterior_compare, fig.cap = "Melded posterior comparison, similar to Figure 8 of the melding paper. Very early version of plot."}
knitr::include_graphics("plots/melded-posterior-compare.png")
```

_Wed Sep 18 15:37:37 2019_: This was written for an earlier version of the plot, which was a reasonable comparison to Figure 8 from the original paper, when chains hadn't gotten stuck out in the tails.

- The shift to the left is explicable / the expected behaviour.
- The right tail of $\phi_{1}$ is underestimated by the naive KDE.
- This _increases_ the probability of moving there in the Stage two acceptance probability.
- When the `wsre` estimate is used, the right tail estimate is improved, and the melded posterior for $\phi_{1}$ is correspondingly shifted to the left.
- This induces a shift in the distribution of $\phi_{2}$ as well, as they are correlated.

The new version of Figure&nbsp;\ref{fig:melded_posterior_compare} has some strange results due to the odd behaviour of some of the chains in Figure&nbsp;\ref{fig:phi_trace_no_wsre}.

# Conclusion

- Melding without employing the weighted-sample self-density ratio estimation (WSRE) idea results in clearly erroneous behaviour
- Whilst there is no baseline "truth" to reference in this example (the implied joint distribution is tricky and not easily sampled), the sampler that employs the WSRE method for $\pd_{2}(\phi)$ produces more feasible results.
- This improved behaviour is obtained using the same number of samples from the prior marginal distributions, or weighted versions thereof. 
- There is some additional computation that must be performed, which results in runtimes of: ? and ?, however comparing these directly is misleading, as the output produced by one is clearly incorrect.

Concise summary

<!-- -------------------- END OF MAIN BODY OF DOCUMENT -------------------- -->
\newpage

<!-- The {-} tag here suppresses the section numbering. -->
# Bibliography {-}

<!-- This makes pandoc-citeproc put the references before the end of document. -->
<div id="refs"></div>

\newpage

<!-- Now switch to alphabetical numbering for the appendix, and reset the counter. -->
\renewcommand{\thesection}{\Alph{section}}
\setcounter{section}{0}

# Appendix 